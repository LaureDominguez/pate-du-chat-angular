<h2 mat-dialog-title>
    {{ data.product ? 'Modifier un produit' : 'Ajouter un produit' }}
</h2>

<form [formGroup]="productForm" (ngSubmit)="save()">
    <!-- Nom -->
    <mat-form-field appearance="fill" class="full-width">
        <mat-label>Nom</mat-label>
        <input matInput formControlName="name" />
    </mat-form-field>

    <!-- Catégorie -->
    <mat-form-field appearance="fill">
        <mat-label>Catégorie</mat-label>
        <mat-select formControlName="category" [compareWith]="compareCategories">
            <mat-option *ngIf="!categories.length">Aucune catégorie</mat-option>
            <mat-option *ngFor="let category of categories" [value]="category">
                {{ category.name }}
            </mat-option>
        </mat-select>
    </mat-form-field>


    <!-- Description -->
    <mat-form-field appearance="fill" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="3"></textarea>
    </mat-form-field>
    
    <!-- Composition -->
    <mat-form-field  appearance="fill">
        <mat-label>Ajouter un ingrédient</mat-label>
        <input 
            type="text"
            matInput
                [formControl]="ingredientCtrl" 
                formControlName="composition"
                [matAutocomplete]="auto"
        />
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="addIngredient($event.option.value)" hideSingleSelectionIndicator>
            <!-- Message pour encourager la recherche -->
            <mat-option *ngIf="!ingredientCtrl.value || ingredientCtrl.value === ''" disabled>
                Commencez à taper pour rechercher un ingrédient
            </mat-option>
            
            <!-- Affichage des résultats filtrés -->
            <mat-option *ngFor="let ingredient of filteredIngredients | async" [value]="ingredient" class="composition">
                <span>{{ ingredient.name }}</span>
                <mat-icon *ngIf="isIngredientSelected(ingredient)">check</mat-icon>
            </mat-option>
            
            <!-- Message pour proposer l'ajout d'un ingrédient  (click)="createIngredient()"-->
            <mat-option *ngIf="noResults" [value]="'noResults'" >
                Aucun résultat. Cliquez ici pour ajouter un nouvel ingrédient.
            </mat-option>
        </mat-autocomplete>
    </mat-form-field>

    <!-- Liste des ingrédients -->
    <mat-chip-set>
        <mat-chip *ngFor="let ingredient of composition" [removable]="true"
            (removed)="removeIngredient(ingredient)">
            {{ ingredient.name }}
            <button mat-icon-button matChipRemove>
                <mat-icon>cancel</mat-icon>
            </button>
        </mat-chip>
    </mat-chip-set>


    <!-- Prix -->
    <mat-form-field appearance="fill" class="full-width">
        <mat-label>Prix</mat-label>
        <input 
            matInput 
            type="number" 
            formControlName="price"
        />
        <span matSuffix>€</span>
    </mat-form-field>

    <!-- Stock -->
    <section class="stock">
        <mat-slide-toggle formControlName="stock" labelPosition="before">
            En stock
        </mat-slide-toggle>
    </section>

    <mat-divider></mat-divider>
    

    <!-- Images -->
    <div class="file-upload">
        <mat-label>Images</mat-label>
        <button mat-raised-button color="primary" type="button" (click)="fileInput.click()">
            <mat-icon>file_upload</mat-icon> Importer une image
        </button>
        <input #fileInput id="imageUpload" type="file" multiple (change)="onFileSelected($event)" accept="image/*"
            style="display: none;" />
    </div>
    
    <div class="previews" *ngIf="filePreviews.length > 0">
        <mat-label *ngIf="existingImageUrls.length > 0">Images à ajouter :</mat-label>
        <div class="previews-container">
            <div class="preview-item" *ngFor="let preview of filePreviews; let i = index">
                <mat-card>
                    <img mat-card-image [src]="preview" alt="Image preview" />
                    <button mat-icon-button color="warn" (click)="removeFile(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </mat-card>
            </div>
        </div>
    </div>
    
    <div class="existing-images" *ngIf="existingImageUrls.length > 0">
        <mat-label *ngIf="filePreviews.length > 0">Images existantes :</mat-label>
        <div class="previews-container">
            <div class="preview-item" *ngFor="let image of existingImageUrls; let i = index">
                <mat-card>
                    <img mat-card-image [src]="image" alt="Existing image" />
                    <button mat-icon-button color="warn" (click)="removeExistingImage(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </mat-card>
            </div>
        </div>
    </div>


    <!-- Validation -->
    <div mat-dialog-actions align="end">
        <button mat-button type="button" (click)="cancel()">Annuler</button>
        <button mat-raised-button color="primary" type="submit">Enregistrer</button>
    </div>
</form>