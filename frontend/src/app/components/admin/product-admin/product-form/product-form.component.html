<h2 mat-dialog-title>
    {{ data.product ? 'Modifier un produit' : 'Ajouter un produit' }}
</h2>

<form 
    [formGroup]="productForm" 
    (ngSubmit)="save()"
>
    <div class="form_content">
        <div class="shadow top-shadow"></div>
        <div class="dynamic_columns">
            <!------------- colonne gauche ------------->
            <div class="form-column">
    
                <!-- bloc nom - category - description -->
                <div class="detail">
                
                    <div class="name_category">
                        <!-- Nom -->
                        <mat-form-field appearance="fill" class="full-width">
                            <mat-label>Nom</mat-label>
                            <input matInput formControlName="name" />
                            <mat-error *ngIf="name?.hasError('required')">Le nom est obligatoire.</mat-error>
                            <mat-error *ngIf="name?.hasError('minlength')">Minimum 2 caractères.</mat-error>
                            <mat-error *ngIf="name?.hasError('maxlength')">Maximum 50 caractères.</mat-error>
                            <mat-error *ngIf="name?.hasError('pattern')">Caractères spéciaux interdits.</mat-error>
                        </mat-form-field>
    
                        <!-- Catégorie -->
                        <mat-form-field appearance="fill">
                            <mat-label>Catégorie</mat-label>
                            <input 
                                type="text" 
                                matInput 
                                [formControl]="categoryCtrl" 
                                [matAutocomplete]="categoryAuto"
                                formControlName="category" 
                                placeholder="Rechercher une catégorie" 
                            />
                            <mat-error *ngIf="category?.hasError('required')">La catégorie est obligatoire.</mat-error>
                            <mat-autocomplete #categoryAuto="matAutocomplete" (optionSelected)="addCategory($event.option.value)">
                                <!-- Affichage des résultats filtrés -->
                                <mat-option *ngFor="let category of filteredCategories | async" [value]="category">
                                    {{ category.name }}
                                </mat-option>
                    
                                <!-- Message pour proposer l'ajout d'un ingrédient  (click)="createIngredient()"-->
                                <mat-option *ngIf="categoryNotFound" [value]="'categoryNotFound'">
                                    Aucun résultat. Cliquez ici pour ajouter une nouvelle catégorie.
                                </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                    </div>          
                    
                    <!-- Description -->
                    <mat-form-field appearance="fill" class="full-width">
                        <mat-label>Description</mat-label>
                        <textarea matInput formControlName="description" rows="3"></textarea>
                        <mat-error *ngIf="description?.hasError('maxlength')">Maximum 500 caractères.</mat-error>
                        <mat-error *ngIf="description?.hasError('pattern')">Certains caractères ne sont pas autorisés.</mat-error>
                    </mat-form-field>
                </div>
                <!-- fin du bloc nom - category - description -->
    
                <!-- ---------------------------------------- -->
                
                <!-- bloc prix - stock -->
                <div class="price_stock">
                    <div class="prix_unite">
                        <!-- Prix -->
                        <mat-form-field appearance="fill" class="full-width">
                            <mat-label>Prix</mat-label>
                            <input matInput type="number" formControlName="price" />
                            <span matSuffix>€</span>
                            <mat-error *ngIf="price?.hasError('required')">Le prix est obligatoire.</mat-error>
                            <mat-error *ngIf="price?.hasError('min')">Le prix doit être un nombre positif ou égale à 0.</mat-error>
                            <mat-error *ngIf="price?.hasError('pattern')">Le format du prix est incorrect (ex: 10.99).</mat-error>
                        </mat-form-field>
        
                        <div class="divider">
                            /
                        </div>
        
                        <!-- Unité -->
                        <mat-form-field appearance="fill">
                            <mat-label>Unité</mat-label>
                            <mat-select formControlName="quantityType">
                                <mat-option value="piece">pièce</mat-option>
                                <mat-option value="kg">kg</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
        
                    <div class="stock_quantity">
                        <!-- Stock -->
                        <section class="stock">
                            <mat-label>En stock</mat-label>
                            <mat-slide-toggle formControlName="stock"></mat-slide-toggle>
                        </section>
                        
                        <!-- Quantité -->
                        <mat-form-field appearance="fill" class="quantity">
                            <mat-label>Quantité en stock</mat-label>
                            <input matInput type="number" min="0" formControlName="stockQuantity" />
                            <span matSuffix> {{ quantityType }} </span>
                            <mat-error *ngIf="productForm.get('stockQuantity')?.hasError('min')">
                                Doit être supérieur ou égal à 0
                            </mat-error>
                        </mat-form-field>
                    </div>
                </div>  
                <!-- fin du bloc prix - stock -->            
            </div>
            <!------------- fin de colonne gauche ------------->
            <mat-divider vertical="true" class="light"></mat-divider>
    
            <!-- ------------------------------------------- -->
    
            <!------------- colonne droite ------------->
            <div class="form-column">
                
                <div class="cooking">
                    <!-- Composition -->
                    <mat-form-field appearance="fill">
                        <mat-label>Composition</mat-label>
                        <input 
                            type="text" 
                            matInput 
                            [formControl]="ingredientCtrl" 
                            [matAutocomplete]="ingredientAuto"
                            formControlName="composition" 
                            placeholder="Rechercher un ingrédient" 
                        />
                        <mat-error *ngIf="composition.length === 0">Ajoutez au moins un ingrédient.</mat-error>
                        <mat-autocomplete #ingredientAuto="matAutocomplete" (optionSelected)="addIngredient($event.option.value)"
                            hideSingleSelectionIndicator>
                            <!-- Affichage des résultats filtrés -->
                            <mat-option *ngFor="let ingredient of filteredIngredients | async" [value]="ingredient" class="composition">
                                <span>{{ ingredient.name }}</span>
                                <mat-icon *ngIf="isIngredientSelected(ingredient)">check</mat-icon>
                            </mat-option>
    
                            <!-- Message pour proposer l'ajout d'un ingrédient  (click)="createIngredient()"-->
                            <mat-option *ngIf="ingredientNotFound" [value]="'ingredientNotFound'">
                                Aucun résultat. Cliquez ici pour ajouter un nouvel ingrédient.
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                        
                    <!-- Liste des ingrédients -->
                    <mat-chip-set *ngIf="composition.length > 0; else noIngredients">
                        <mat-chip 
                            *ngFor="let ingredient of composition" 
                            [removable]="true" 
                            (removed)="removeIngredient(ingredient)"
                            [matTooltip]="getIngredientTooltip(ingredient)" 
                            matTooltipPosition="below" 
                            matTooltipClass="custom-tooltip"
                        >
                            {{ ingredient.name }}
                            <button mat-icon-button matChipRemove>
                                <mat-icon>cancel</mat-icon>
                            </button>
                        </mat-chip>
                    </mat-chip-set>
    
                    <ng-template #noIngredients>
                        <p class="empty-message">Aucun ingrédient ajouté</p>
                    </ng-template>
    
                    <mat-divider></mat-divider>
    
                    <!-- Instructions de cuisson -->
                    <mat-form-field appearance="fill">
                        <mat-label>Instructions de cuisson</mat-label>
                        <textarea matInput formControlName="cookInstructions" rows="3"></textarea>
                    </mat-form-field>
    
                    <!-- DLC -->
                    <mat-form-field appearance="fill">
                        <mat-label>Durée de consommation (DLC)</mat-label>
                        <mat-select formControlName="dlc">
                        <mat-option value="3 jours">3 jours</mat-option>
                        <mat-option value="6 jours">6 jours</mat-option>
                        <mat-option value="1 semaine">1 semaine</mat-option>
                        <mat-option value="2 semaines">2 semaines</mat-option>
                        <mat-option value="Autre">Autre...</mat-option>
                        </mat-select>
                    </mat-form-field>
    
                    <!-- DLC Custom (si Autre...) -->
                    <mat-form-field *ngIf="productForm.get('dlc')?.value === 'Autre'" appearance="fill">
                        <mat-label>Préciser la durée</mat-label>
                        <input matInput formControlName="customDlc" />
                    </mat-form-field>
                
                </div>
                
            </div>
            <!------------- fin de colonne droite ------------->
        </div>
        <!------------- fin du bloc de 2 colonnes ------------->

        <mat-divider class="light"></mat-divider>
    
        <!------------- bloc images ------------->
        <div class="bloc_images">
            <div class="img_label">
                <mat-label>Images</mat-label>
                <button mat-raised-button color="primary" type="button" (click)="fileInput.click()">
                    <mat-icon>file_upload</mat-icon> Ajouter une image
                </button>
            </div>
            <input 
                #fileInput  
                id="imageUpload" 
                type="file" 
                multiple 
                (change)="onFileSelected($event)" 
                accept="image/*"
                style="display: none;" 
            />
            <app-image-carousel
                [images]="processedImages"
                (reorder)="processedImages = $event"
                (remove)="onImageRemoved($event)"
                (download)="downloadImage($event)"
            />
            <!-- <app-image-carousel
                [existingImages]="existingImageUrls"
                [previewImages]="filePreviews"
                (removeExisting)="removeExistingImage($event)"
                (removePreview)="removeFile($event)"
                (download)="downloadImage($event)"
                (reorderExisting)="existingImageUrls = $event"
                (reorderPreview)="filePreviews = $event"
            /> -->
        </div>
        <div class="shadow bottom-shadow"></div>
    </div>

    <!-- ------------------ -->

    <!-- Validation -->
    <div mat-dialog-actions class="actions" align="end">
        <button mat-button type="button" (click)="cancel()">Annuler</button>
        <button mat-raised-button color="primary" type="submit">Enregistrer</button>
    </div>
</form>