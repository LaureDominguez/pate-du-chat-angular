<h2 mat-dialog-title>
    {{ data.product ? 'Modifier un produit' : 'Ajouter un produit' }}
</h2>

<form [formGroup]="productForm" (ngSubmit)="save()">
    <!-- Nom -->
    <mat-form-field appearance="fill" class="full-width">
        <mat-label>Nom</mat-label>
        <input matInput formControlName="name" />
    </mat-form-field>

    <!-- Catégorie -->
    <mat-form-field appearance="fill">
        <mat-label>Catégorie</mat-label>
        <mat-select formControlName="category">
            <mat-option *ngFor="let category of categories" [value]="category._id">
                {{ category.name }}
            </mat-option>
        </mat-select>
    </mat-form-field>

    <!-- Description -->
    <mat-form-field appearance="fill" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="3"></textarea>
    </mat-form-field>
    
    <!-- Ingrédients -->
    <mat-form-field>
        <mat-label>Ajouter un ingrédient</mat-label>
        <input 
            type="text"
            matInput
                [formControl]="ingredientCtrl" 
                [matAutocomplete]="auto"
        />
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="addIngredient($event.option.value)">
            <!-- Message pour encourager la recherche -->
            <mat-option *ngIf="!ingredientCtrl.value || ingredientCtrl.value === ''" disabled>
                Commencez à taper pour rechercher un ingrédient
            </mat-option>
            
            <!-- Affichage des résultats filtrés -->
            <mat-option *ngFor="let ingredient of filteredIngredients | async" [value]="ingredient">
                {{ ingredient.name }}
            </mat-option>
            
            <!-- Message pour proposer l'ajout d'un ingrédient  (click)="createIngredient()"-->
            <mat-option *ngIf="noResults" [value]="'noResults'" >
                Aucun résultat. Cliquez ici pour ajouter un nouvel ingrédient.
            </mat-option>
        </mat-autocomplete>
    </mat-form-field>

    <mat-chip-set>
        <mat-chip *ngFor="let ingredient of productForm.get('composition')?.value" [removable]="true"
            (removed)="removeIngredient(ingredient)">
            {{ ingredient.name }}
            <button mat-icon-button matChipRemove>
                <mat-icon>cancel</mat-icon>
            </button>
        </mat-chip>
    </mat-chip-set>


    <!-- Prix -->
    <mat-form-field appearance="fill" class="full-width">
        <mat-label>Prix</mat-label>
        <input matInput type="number" formControlName="price" />
    </mat-form-field>

    <!-- Stock -->
    <div class="stock">
        <mat-checkbox formControlName="stock">En stock</mat-checkbox>
    </div>

    <!-- Validation -->
    <div mat-dialog-actions align="end">
        <button mat-button type="button" (click)="cancel()">Annuler</button>
        <button mat-raised-button color="primary" type="submit">Enregistrer</button>
    </div>
</form>